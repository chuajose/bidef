<?php if ( ! defined('BASEPATH')) exit('No direct script access allowed');

class Email extends CI_Controller {

	var $login = FALSE;
	var $username ="";
	var $password = "";

	function __construct(){

		parent::__construct();

		$this->load->library('webmail_imap');

		if($this->session->userdata('username') && $this->session->userdata('password'))
		{
			$this->username               = $this->session->userdata('username');
			$this->password               = $this->session->userdata('password');
			$this->webmail_imap->username = $this->session->userdata('username');
			$this->webmail_imap->password = $this->session->userdata('password');

			$this->login = $this->webmail_imap->login();

		}
        
	}

	function login()
	{
		$mensaje=FALSE;
			

			/*$this->webmail_imap->host="packgacela.com";
			$this->webmail_imap->port=143;
		    $this->webmail_imap->conectar();*/



		if($_POST){

			$this->username = $this->input->post('username');
			$this->password = $this->input->post('password');

			//echo $this->input->post('username').$this->input->post('password');
			$this->webmail_imap->username =  $this->input->post('username');
			$this->webmail_imap->password = $this->input->post('password');
			
			$this->login = $this->webmail_imap->login();

			if($this->login){

				$datos = array(
					'username' => $this->username,
					'password' => $this->password
					);

			 	$this->session->set_userdata($datos);

			 	redirect('email/index');
			}

			$mensaje = "Error en la conexion";

		}
		$this->load->view('login',array('mensaje'=>$mensaje));

	}

	function logout()
	{

		$array_items = array('username' => '', 'password' => '');
		$this->session->unset_userdata($array_items);
		redirect('email/login');
	}

	function index($bandeja='inbox', $pagina=0)
	{

		if(!$this->login) redirect('email/login');

		$mensajes = array();
		$bandejas = array();
		$palabra = false;

		if($_POST){

			$palabra = $this->input->post('palabra');

		} 


		$_bandejas = $this->webmail_imap->listar_bandejas();

		$bandejas=array();

		if($_bandejas){

			foreach ($_bandejas as $key => $value) {

				$bandejas[$value]=$this->webmail_imap->total($value);

			}
		}

		if($bandeja)$this->webmail_imap->seleccionar_bandeja($bandeja);
		if(!$palabra)$mensajes = $this->webmail_imap->listar_mensajes($pagina);
		else $mensajes = $this->webmail_imap->buscar($palabra,$pagina);


		$this->load->library('pagination');

		$config['base_url'] = base_url().'email/index/'.$bandeja;
		$config['total_rows'] = $this->webmail_imap->total($bandeja);
		$config['per_page'] = 10;
		$config['uri_segment'] = 4;

		$this->pagination->initialize($config);

				

		$this->load->view('email_list',array('mensajes'=>$mensajes,'palabra'=> $palabra, 'bandejas'=>$bandejas,'bandeja'=>$bandeja));
	}

	function borrar($bandeja)
	{

		if(!$this->login) redirect('email/losgin');

		$this->webmail_imap->borrar_bandeja($bandeja);

		redirect('email/index');
	}

	function mover_mensaje()
	{

		if($_POST) {

			$ids= $this->input->post('msg_id');
			$origen= $this->input->post('origen');
			$destino= $this->input->post('destino');
			$this->webmail_imap->mover_mensaje($origen,$destino,$ids);
			redirect('email/index/'.$origen);
		}
	}

	function send()
	{

	
		$this->load->library('webmail_imap');
		$this->webmail_imap->enviar();
		/*

		include 'Mail.php';
		include 'Mail/mime.php' ;

		$text = 'Text version of email';
		$html = '<html><body>HTML version of email</body></html>';
		$file = '/home/richard/example.php';
		$crlf = "\n";
		$hdrs = array(
		              'From'    => 'you@yourdomain.com',
		              'Subject' => 'Test mime message'
		              );

		$mime = new Mail_mime(array('eol' => $crlf));

		$mime->setTXTBody($text);
		$mime->setHTMLBody($html);
		$mime->addAttachment($file, 'text/plain');

		$body = $mime->get();
		$hdrs = $mime->headers($hdrs);

		$mail =& Mail::factory('mail');
		$mail->send('postmaster@localhost', $hdrs, $body);
		*/


	}

}